<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Morning SIR! — 服务用语训练 </title>
  <link rel="stylesheet" href="assets/css/styles.css?v=2" />
  <!-- Progressive Web App / iOS Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Morning SIR!">
  <link rel="apple-touch-icon" sizes="192x192" href="assets/img/minilogo.png">
  <link rel="manifest" href="manifest.json">
  <!-- theme-color meta moved to JS to avoid static compatibility warning -->
  <meta name="color-scheme" content="light dark">
  <script>
    (function(){
      // Create meta dynamically (linters won't flag unsupported static usage)
      var meta = document.querySelector('meta[name="theme-color"]') || (function(){
        var m = document.createElement('meta');
        m.name = 'theme-color';
        document.head.appendChild(m);
        return m;
      })();
      function apply(){
        var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        meta.setAttribute('content', dark ? '#111827' : '#0A66FF');
      }
      apply();
      try {
        var mq = window.matchMedia('(prefers-color-scheme: dark)');
        if (mq.addEventListener) mq.addEventListener('change', apply);
        else if (mq.addListener) mq.addListener(apply);
      } catch(e){}
    })();
  </script>
</head>
<body class="root">
  <header class="appbar">Morning SIR! — 服务用语训练 <span class="version-badge">V8</span></header>
  <div class="hero">
    <div>
  <div class="header-brand"><img src="assets/img/logo_full.svg" alt="AVSECO" class="header-logo"/></div>
  <div class="header-sub">针对旅客服务场景的英语用语练习</div>
    </div>
  </div>

  <main id="views">
  <!-- 主页 -->
    <section id="home" class="view panel active">
      <div class="card card--pad">
  <h2 class="h2--no-margin">欢迎使用</h2>
  <p class="muted p--no-margin">这是一个浏览器版：提供标准语音播放、录音与回放、AI 评分（发音/流利度）与中文详细解释。录音最长 15 秒，已适配 iOS/Android 主流浏览器（允许录音权限后即可使用）。</p>
        <div class="row row--mt">
          <button class="btn secondary" onclick="switchTab('practice')">前往练习</button>
          <button class="btn primary" onclick="alert('Morning SIR! H5\n\n• AI 评分 + 中文详细解释\n• 录音 ≤ 15 秒，支持回放')">关于本示范</button>
        </div>
      </div>
    </section>

  <!-- 练习：课程列表 + 闪卡 -->
    <section id="practice" class="view panel">
  <h2>课程列表</h2>
      <div id="courseList" class="list"></div>

      <div id="session" class="hidden">
        <div class="row">
          <div id="courseTitle" class="course-title"></div>
          <div class="right muted" id="counter">0/0</div>
          <button type="button" class="btn secondary hidden" id="btnExitCourse">退出课程</button>
        </div>
        <div class="progress"><div id="progressBar"></div></div>

        <div id="flashcard" class="flashcard" aria-live="polite">
          <div class="zh" id="fcZh">—</div>
          <div class="en" id="fcEn">—</div>
          <div class="chips" id="chips"></div>
          <div class="hint">向<b>左滑</b>＝已认识 • 向<b>右滑</b>＝加入多练</div>
        </div>

        <div class="toolbar">
          <button class="btn secondary" id="btnPlay">▶︎ 播放</button>
          <button class="btn secondary" id="btnRecord">● 录音</button>
            <button class="btn secondary" id="btnPlayback" disabled>回放</button>
          <button class="btn success" id="btnScore" disabled>★ 评分</button>
        </div>

        <div id="result" class="result"></div>
        <div class="row row--mt-sm">
          <button class="btn secondary" id="btnPrev" type="button">← 上一张</button>
          <button class="btn primary right" id="btnNext" type="button">下一张 →</button>
        </div>

        <div id="summary" class="summary card summary--card">
          <h3 class="h3--no-margin">本次练习总结</h3>
          <div class="grid">
            <div class="kpi"><div class="muted">卡片数</div><div id="smCards" class="en">0</div></div>
            <div class="kpi"><div class="muted">平均分</div><div id="smAvg" class="en">—</div></div>
            <div class="kpi"><div class="muted">需要多练</div><div id="smHard" class="en">0</div></div>
            <div class="kpi"><div class="muted">已认识</div><div id="smEasy" class="en">0</div></div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>
    </section>

  <!-- 报告 -->
    <section id="reports" class="view panel">
  <h2>报告 <button class="btn secondary hidden" id="btnReportBack" type="button">← 返回</button></h2>
  <div class="card card--pad">
        <div class="row row--mt" id="reportLinksRow">
          <button class="btn secondary" id="btnReportIndividual" type="button">個人報告</button>
          <button class="btn secondary hidden" id="btnOverallReports" type="button">整體報告</button>
        </div>
  <div id="reportEmbed" class="row row--mt hidden report-embed">
          <iframe id="reportFrame" title="Reports" src="about:blank" class="report-frame"></iframe>
        </div>
        <p class="muted">此页仅展示您在本设备上的简单练习统计（示范）。</p>
        <div class="grid grid--two">
          <div class="kpi"><div class="muted">练习次数</div><div id="rSessions" class="en">0</div></div>
          <div class="kpi"><div class="muted">平均分</div><div id="rAvg" class="en">—</div></div>
        </div>
      </div>
      <div class="spacer"></div>
    </section>

  <!-- 我的 -->
    <section id="profile" class="view panel">
  <h2>我的</h2>
  <div class="card card--pad">
<label class="muted" for="nickname">昵称</label>
<input id="nickname" placeholder="请输入昵称" class="nickname-input"/>
<div class="hint"></div>

  <hr class="profile-divider" />
  <h3 class="h3-achievement">我的成就</h3>
      <div class="pins-grid" id="myPins">
        <!-- pins will be inserted here -->
      </div>
      </div>
      <div class="spacer"></div>
    </section>
  </main>

  <!-- 底部导航 -->
  <nav class="tabbar">
    <div class="tab active" data-tab="home" data-icon-default="assets/tabbar/home.png" data-icon-selected="assets/tabbar/home_selected.png">
      <img src="assets/tabbar/home_selected.png" alt="主页">
  <div class="tab-label">主页</div>
    </div>
    <div class="tab" data-tab="practice" data-icon-default="assets/tabbar/practice.png" data-icon-selected="assets/tabbar/practice_selected.png">
      <img src="assets/tabbar/practice.png" alt="练习">
  <div class="tab-label">练习</div>
    </div>
    <div class="tab" data-tab="reports" data-icon-default="assets/tabbar/reports.png" data-icon-selected="assets/tabbar/reports_selected.png">
      <img src="assets/tabbar/reports.png" alt="报告">
  <div class="tab-label">报告</div>
    </div>
    <div class="tab" data-tab="profile" data-icon-default="assets/tabbar/profile.png" data-icon-selected="assets/tabbar/profile_selected.png">
      <img src="assets/tabbar/profile.png" alt="我的">
      <div class="tab-label">我的</div>
    </div>
  </nav>

  <script>
    // ====== 全局音频路径前缀 ======
    const AUDIO_BASE = 'assets/audio/';
    function resolveAudio(file){
      if(!file) return '';
      if(/^(?:https?:)?\/\//.test(file) || file.startsWith(AUDIO_BASE)) return file; // already absolute or prefixed
      return AUDIO_BASE + file.replace(/^\/+/, '');
    }
    
    // ====== 課程資料（包含 AVSECO 基礎 10 句） ======
    const COURSES = [
      // ===== Course: Greetings =====
      {
        id: 'course_1',
        title: 'Greetings (打招呼)',
        color: '#dcfce7',
        cover: 'assets/img/cover-greeting.jpg',
        phrases: [
          { zh: '嗨', en: 'Hello / Hi!', audio: 'df27849256656384bae75a1609088ca445ca2016.mp3' },
          { zh: '你好吗?', en: 'How are you?', audio: '3031897e282167593fbb4dbe81dc48ebbe9a002d.mp3' },
          { zh: '今天过得怎么样?', en: 'How are you today?', audio: 'f24d135c348d6a82968d3f06d5e26e6177b95cd8.mp3' },
          { zh: '早上好', en: 'Good morning.', audio: '5c3e9f7ad0c9c2b824bab5400d074c38f6d6cbe0.mp3' },
          { zh: '下午好', en: 'Good afternoon.', audio: '436f04733e77c6c81283567211c05f0750a71919.mp3' },
          { zh: '晚上好', en: 'Good evening.', audio: '462267e23cd806a5d570025547c896387d626d68.mp3' },
          { zh: '很高兴认识你', en: 'Nice to meet you!', audio: '55c5a325bc299849659780b31dae1882e924efff.mp3' },
          { zh: '我很好,谢谢你!', en: "I'm fine, thank you.", audio: 'beac659eced816c9091692ece0fb1ba0b2e3d73d.mp3' },
          { zh: '还不错,谢谢你!', en: 'Not too bad, thanks!', audio: '68456c7db73f40cd6e5b7a48d8e69923e7495a76.mp3' },
          { zh: '你好, 有什么可以帮忙吗?', en: 'Hello. How can I help?', audio: '25938798839e25d93e9a6e746421fd617dc5684d.mp3' },
          { zh: '欢迎来到香港', en: 'Welcome to Hong Kong', audio: 'a2e1291a40f08aff7f8bdccc7563a40adc09573b.mp3' },
          { zh: '祝你有一个愉快的一日', en: 'Have a nice day', audio: 'b6bab9bc8870165ecb6c16e713339e4981432239.mp3' }
        ]
      },
      // ===== New Course: Asking / Responding to Questions with... =====
      {
        id: 'course_2',
        title: 'Asking / Responding to Questions with...(基本問答)',
        color: '#fde68a',
        cover: 'assets/img/cover-greeting.jpg', // placeholder cover (reuse greeting) – replace if a dedicated image is added
        phrases: [
          { zh: '如何 (我如何到达…？)', en: 'How (i.e. How do I get to ...?)', audio: '30a09d58e2a18781c9c877f36c286737a6948a15.mp3' },
          { zh: '哪里（…在哪里？）', en: 'Where (i.e. Where is the ...?)', audio: '6ffdad162e0588c5834a300b43f43f85c1c1495b.mp3' },
          { zh: '什么时候（您什么时候返回香港？）', en: 'When (i.e. When will you return to Hong Kong?)', audio: 'e79f1a5549d12c7537fb4d284a16c6bee02bce35.mp3' },
          { zh: '什么（现在几点？）', en: 'What (i.e. What time is it?)', audio: 'def9229b9ff9fcc834b91ae9598fd9efb6252602.mp3' },
          { zh: '为什么（为什么我不能使用电子频道？）', en: "Why (i.e. Why can't I use the e-channel?)", audio: '563c87590c3ec47ce8526817318210e5128a3897.mp3' }
        ]
      },
      // ===== New Course: Days of the Week =====
      {
        id: 'course_3',
        title: 'Days of the Week(星期的名称)',
        color: '#e0f2fe',
        cover: 'assets/img/cover-greeting.jpg', // reuse placeholder
        phrases: [
          { zh: '星期一', en: 'Monday', audio: '932eeb1076c85e522f02e15441fa371e3fd000ac.mp3' },
          { zh: '星期二', en: 'Tuesday', audio: '42e43b612a5dfae57ddf5929f0fb945ae83cbf61.mp3' },
          { zh: '星期三', en: 'Wednesday', audio: '5656b9b79b0316fc611a9c30d2ffac25228b8371.mp3' },
          { zh: '星期四', en: 'Thursday', audio: '76031ddf92450ba52c1e3945097079807a9065c2.mp3' },
          { zh: '星期五', en: 'Friday', audio: 'd166e844a3f3f87149cc4f866eb998e9a751c72a.mp3' },
          { zh: '星期六', en: 'Saturday', audio: '17063c506b81a46c2eb7716af50cf19d4ed5a6c6.mp3' },
          { zh: '星期日', en: 'Sunday', audio: 'bc5dd045b8623ddfc4bd0bce98ca5fda42accf88.mp3' },
          { zh: '昨天', en: 'Yesterday', audio: 'da24830f1f7072d55862afb6969c1a4c433ac056.mp3' },
          { zh: '今天', en: 'Today', audio: '24345a14377fd821d3932f4e82f6431640955b0b.mp3' },
          { zh: '明天', en: 'Tomorrow', audio: '1948bf2dfa8fbc1f07ad3b6f0e2b3ee39f87e495.mp3' } // corrected spelling from Tommorow
        ]
      },
      // ===== Split Course: Direction Guide - Directions =====
      {
        id: 'course_4',
        title: 'Direction Guide - Directions (方向指導-方向)',
        color: '#a5f3fc',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '转左', en: 'Turn left', audio: '920999160e9ea084f372a97bda31da797ba9923a.mp3' },
          { zh: '转右', en: 'Turn right', audio: '39fa445c175d0e6ab6479f9ab155502210b1d0ce.mp3' },
          { zh: '直行', en: 'Go straight', audio: 'cd77124e8ae5fda2f9699e0028c3bca60eca892f.mp3' },
          { zh: '继续走', en: 'Keep going', audio: '6902b083a9c13fe725148faed9ceee2277e3ac01.mp3' },
          { zh: '上楼', en: 'Go upstairs', audio: 'f5986810a4326f9c556ab810b5beed5a83549fc4.mp3' },
          { zh: '下楼', en: 'Go downstairs', audio: '62fee0041bcfab8e3e3d7ce25c49162a339de4ee.mp3' },
          { zh: '楼梯', en: 'Staircase', audio: '15ccb289ff73c15c072868cbc16ca91887182752.mp3' },
          { zh: '电梯/升降机', en: 'Elevator / Lift', audio: 'f4f99e3566b6888169ac527ad9ef22b9f88f6488.mp3' },
          { zh: '扶手电梯', en: 'Escalator', audio: '5d4ea9cc2b76157bb20e2ce2187c131a0288732c.mp3' },
          { zh: '旁边', en: 'Next to', audio: '1fc33fc3896a92e77bf2ecd29fb7f0f37d1ae3a3.mp3' },
          { zh: '后面', en: 'Behind', audio: '8dd3ec3d963acb22ced18b20b48d12e8ff152776.mp3' },
          { zh: '对面', en: 'Across from', audio: '740740ac02457d8cd56bb062d51074099b22c174.mp3' },
          { zh: '之间', en: 'Between', audio: '1b22feb0c0c13c69ebe6389111ff7312bd0c946b.mp3' },
          { zh: '近≠远', en: 'Near / Far', audio: '84096183d889cd36f7a0c225987e0dde4027219b.mp3' },
          { zh: '经过', en: 'Pass', audio: 'd7cd56f2a2a3f47830760edfb89946eb7b9e2cd1.mp3' },
          { zh: '通过', en: 'Go through', audio: '7b4710b680df9dac4feebf5a0bfcdbbf9bef216e.mp3' },
          { zh: '靠（左/右）侧', en: 'Keep to (left / right) side', audio: '2ed8fb8f1e0be2d4d9b74772dfa41a9af5844afe.mp3' },
          { zh: '在 (左/右)边', en: 'On (left / right) side', audio: '43981986538d5ae753c80dfc1012ab36cb966e16.mp3' },
          { zh: '朝 _________ 方向前进', en: 'Heading towards _________ direction', audio: '58a86ab5b09d7ee2bcd591892018de54da85590b.mp3' },
          { zh: '我怎么去 ________________？', en: 'How do I get to ________________?', audio: '03dd113c931f6221ff8006f767822a21ad8866e9.mp3' },
          { zh: '__________ 在哪里？', en: 'Where is the __________?', audio: '9af68f22a14fa55b8437d2ea2091c1c1a33eac17.mp3' },
          { zh: '这附近有 ________ 吗？', en: 'Is there a ________ near here?', audio: 'c766de4af0b1b4239cfaaa0897587b7de236ac72.mp3' }
        ]
      },
      // ===== Split Course: Direction Guide - Facilities =====
      {
        id: 'course_5',
        title: 'Direction Guide - Facilities (方向指導-設施)',
        color: '#cffafe',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '餐厅', en: 'Restaurant / Food court', audio: '05871b8de523abc9d062ad34328eddc9e46abd19.mp3' },
          { zh: '询问处', en: 'Information desk', audio: 'd02f01116f2a9346ccef13a7d9e3921c5ae8c98a.mp3' },
          { zh: '登机办理处', en: 'Check-in counter', audio: 'e596244d65bca1e4ad997d85134aed2e72e6e3c8.mp3' },
          { zh: '安检', en: 'Security check', audio: 'daa2684691dd1c32132f2006aa810f54e6670d4e.mp3' },
          { zh: '转机安检站', en: 'Transfer checkpoint', audio: '8957e3683226ae3cd6621daf0804bcd8376a5391.mp3' },
          { zh: '离境', en: 'Departure', audio: '0a9a13d7407d98a132bc64ac70698123817675c3.mp3' },
          { zh: '抵达', en: 'Arrival', audio: 'dc21d2b4eede6e5dd86091471b205b4b6fecd76a.mp3' },
          { zh: '登机闸口', en: 'Gate', audio: '5701b5f6feaa9aaae618dd553adc29893963cc1a.mp3' },
          { zh: '登机证', en: 'Boarding pass', audio: 'c16dd8a6f9a78a0f534512a6b978ba0e9b864b37.mp3' },
          { zh: '护照', en: 'Passport', audio: 'd5ed1ca0e30841762087801ad0ea2356bf068bd4.mp3' },
          { zh: '吸烟区', en: 'Smoking area', audio: '53fc7f4cd0c79850a7a085830ad275ff4715533e.mp3' },
          { zh: '入境', en: 'Immigration', audio: '061873e7aac53da2292fa599c17e00b2657c27f9.mp3' },
          { zh: '海关', en: 'Customs', audio: '22c43c80b6acba6c8e988834746cb3dad10dc13a.mp3' },
          { zh: '行李', en: 'Baggage', audio: '84d720460886864c17b29e5c55ef2b6ecf65c2f9.mp3' },
          { zh: '天际走廊', en: 'Skybridge', audio: 'ad6a6d4f66e00aab3582976b8fc34402ba756ed3.mp3' },
          { zh: '空中花园', en: 'Skygarden', audio: '17f127ae7d24e70a19a932ee68eb6b3604293525.mp3' },
          { zh: '洗手间', en: 'Toilet / Restroom / WC', audio: '46b5726a903d265f4897e71f027e2d745726c498.mp3' },
          { zh: '免税店', en: 'Duty-free shops', audio: '6247020386542e25c935fc12dfb772364e517ffd.mp3' },
          { zh: '咖啡店', en: 'Coffee shop', audio: 'a65560eef6929169012f77afb67122f291e1ab9c.mp3' },
          { zh: '饮用水 / 补充水 站', en: 'Drinking water / Refill water spot / Water zone', audio: '1816e23ed5450a4297ee547446da135fd55806ff.mp3' },
          { zh: '旅客捷运系统', en: 'Automated people mover (APM)', audio: '1d02f962a47fa71ffc7a979c458a450ef4d583a7.mp3' },
          { zh: '接驳列车 / 接驳巴士', en: 'Shuttle train / bus', audio: 'bfb58fb517728b76446051bfa7074734de4b95bb.mp3' }
        ]
      },
      // ===== New Course: Numbers =====
      {
        id: 'course_6',
        title: 'Numbers (数字)',
        color: '#fde047',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '1', en: 'One', audio: 'b58b5a8ced9db48b30e008b148004c1065ce53b1.mp3' },
          { zh: '2', en: 'Two', audio: '16e018ece5a1d3b750531de58d16b961de23d629.mp3' },
          { zh: '3', en: 'Three', audio: 'f3cd4632fcbc2f87e24127e107068b28ca4b8862.mp3' },
          { zh: '4', en: 'Four', audio: 'c5d87b23f24ed0de795c83cc3a260e8ee53e8e96.mp3' },
          { zh: '5', en: 'Five', audio: 'f8ed82841b9b517e3ff177a45191feb4d0d44404.mp3' },
          { zh: '6', en: 'Six', audio: 'b10d6634633e094c200b7e34d8a2a5b113aa672d.mp3' },
          { zh: '7', en: 'Seven', audio: '63abb5650ff592fc4e4ddbac60437510594a3f21.mp3' },
          { zh: '8', en: 'Eight', audio: '20c26c702a685c517e9c11eec1635199fead87b3.mp3' },
          { zh: '9', en: 'Nine', audio: '535bb8d4292925f56cdaf3313eff834e515dd971.mp3' },
          { zh: '10', en: 'Ten', audio: '83173a1aa745fdc8faff4cff717d9df1257b7c94.mp3' },
          { zh: '11', en: 'Eleven', audio: 'b4a1b960f53db2f23b46796c12056a591eb0a724.mp3' },
          { zh: '12', en: 'Twelve', audio: 'f14bcf9b919fc82492e8ad5859dc8aa196f600be.mp3' },
          { zh: '13', en: 'Thirteen', audio: '7933258ec6036a4126be12b23cbd15723172492f.mp3' },
          { zh: '14', en: 'Fourteen', audio: '55d9600679c08f255546c5fb47c6b360496a8a6d.mp3' },
          { zh: '15', en: 'Fifteen', audio: 'a20dd5f284e5b31a96f186bae6e5e20e0c1c2ca6.mp3' },
          { zh: '16', en: 'Sixteen', audio: '262ca2b5696b3390d4bf6482f0bd7e6a401a5f00.mp3' },
          { zh: '17', en: 'Seventeen', audio: '39e498a0910939dc0f6eab4a45242f97a09d2d49.mp3' },
          { zh: '18', en: 'Eighteen', audio: '10d7b30d66b56ea44ff0ac85476eb6d8f3b1e38a.mp3' },
          { zh: '19', en: 'Nineteen', audio: '8e59618dd8cf0bd30b020208a78674c2e8b2a77c.mp3' },
          { zh: '20', en: 'Twenty', audio: 'ed0434fcc20c5b7e358223ba70111fc1ccfdc9e5.mp3' },
          { zh: '30', en: 'Thirty', audio: 'f57a4f849a3dd86651b8be838f1b4aad6fb2a5ea.mp3' },
          { zh: '40', en: 'Forty', audio: '0ec7f550c108e1f62ee6c75c75bf1be5feffa893.mp3' },
          { zh: '50', en: 'Fifty', audio: '812852df341909dd856722be95f03b3851bcd471.mp3' },
          { zh: '60', en: 'Sixty', audio: '00a0861c1ff50340fbf7526907d1044854648eae.mp3' },
          { zh: '70', en: 'Seventy', audio: 'a666f058cd8ebbab03349defdddf1191dd7b5768.mp3' },
          { zh: '80', en: 'Eighty', audio: 'a6435a5f1a17793237f5664c6b807743959b6d8c.mp3' },
          { zh: '90', en: 'Ninety', audio: '6d1b0bc8d2c11969c72da95b8fd4074a7ce6e6e9.mp3' },
          { zh: '100', en: 'One hundred', audio: '0e6e78d65739299428bfe1b768fa059f6a189822.mp3' },
          { zh: '1,000', en: 'One thousand', audio: '728bed68062a366bff66020c1b37bd1e9facfef2.mp3' },
          { zh: '10,000', en: 'Ten thousand', audio: 'c6a46fc274a766372b3740ed12a0fc0dd7c72c35.mp3' }
        ]
      },
      // ===== New Course: Passenger Screening =====
      {
        id: 'course_7',
        title: 'Passenger Screening (乘客安检)',
        color: '#ddd6fe',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '请排队', en: 'Please line-up / queue up.', audio: '8a263f9333c210a802b2b91f7a1a9070d03d207f.mp3' },
          { zh: '请向前/向后走。', en: 'Please step forward / backward.', audio: 'a23017447cc100933ed347307c94aed6b75f75ae.mp3' },
          { zh: '请用左/右方位置', en: 'Please use the left / right position.', audio: '359d904f3d1ee2e51c94e1c42a39a5857485f40a.mp3' },
          { zh: '请取托盘', en: 'Please take the tray.', audio: 'd018110a9f3422578cb71e8127cdc3387c7756f5.mp3' },
          { zh: '请将所有物品放入托盘。', en: 'Please put all items in the tray.', audio: '21769eb7f642154715a1f34251c1b322999cad98.mp3' },
          { zh: '请将所有行李放入托盘。', en: 'Please put all baggages / luggages in the tray.', audio: '02a72e0ad14bb62fd454820b9f6745f417e0a732.mp3' },
          { zh: '请将电脑/平板电脑取出，并放置在其他托盘中。', en: 'Please take out your computer / tablet, and place it in another tray.', audio: 'ccbb7906579c92ac92ffa17d9e05cba5a4c734da.mp3' },
          { zh: '无需将电脑/平板电脑从包中取出。', en: 'No need to take the computer / tablet out of the bag.', audio: '2a835d8546a3b131e1b57b7752611e6d60ddc215.mp3' },
          { zh: '请稍等', en: 'Please wait / hold on / wait a moment.', audio: 'd1a2e7401c37372ca5a6964de97c3f82bbb3383e.mp3' },
          { zh: '请脱下您的帽子', en: 'Please take off your hat.', audio: 'a08426635d040f7fc8951105d66f19494a8ccad4.mp3' },
          { zh: '我可以看一下您的登机证吗？', en: 'May I see your boarding pass please?', audio: 'cb8b241ff64c272a5549a4b5bcca28bebd131234.mp3' },
          { zh: '您的航班号是什么？', en: 'What is your flight number?', audio: '858053a456a8e6294695d38fab9a48e73e1b8772.mp3' },
          { zh: '请一个接一个地通过。', en: 'Please go through one by one.', audio: '3875be3536992bba7a2e71e784e1d5a98f2f060d.mp3' },
          { zh: '请从口袋里取出所有物品并放入此托盘中。', en: 'Please take out all the items from your pockets and put them in this tray.', audio: '8ca74a1438210fe6c13f6fce0d136a2f6382bb0a.mp3' },
          { zh: '请站在这个脚印上，按照这个标志，张开你的双臂。', en: 'Please stand on this footprint, follow this sign and spread out your arms.', audio: '7259510dd6e406940a807e10d977cd41732981c0.mp3' },
          { zh: '我们现在将进行人手检查。', en: 'We will now do a pat-down search.', audio: '959e86fd4fdf35938eb1f94d02de12e59586d5ed.mp3' },
          { zh: '这是一个随机检查', en: 'This is a random search.', audio: '610d9d164363b67ccd24d1dd737f105f0cc695f8.mp3' },
          { zh: '这个包 / 行李需要开包检查', en: 'This bag / luggage will have to be open checked.', audio: '09021df5de300d9a9367c8e1e20e18ca46b29b4f.mp3' },
          { zh: '您还有其他的行李吗？', en: 'Do you have other bags?', audio: 'c5d87ea5d8d52e065b0c7fb793da714ab4607f6e.mp3' },
          { zh: '您可以在安检后到饮水站补充水。', en: 'You can refill water at the water station after the security check.', audio: '62af2618e8e49a8257ec4fa65176f846e3956570.mp3' },
          { zh: '请清空瓶子/容器。', en: 'Please empty the bottle / container.', audio: 'e7fdc8ffa9e9d83cc9640c55904951ed1a0df568.mp3' },
          { zh: '随身行李中不允许携带超过 100 毫升的液体/水/饮料。', en: 'Liquids / water / soft drinks over 100 ml are not allowed in carry-on baggage.', audio: '0093043ef21489979d7da9520f3389e52a97cf5f.mp3' },
          { zh: '出于安全原因，此物品不能带上飞机。', en: 'For safety reasons, this cannot be taken on-board.', audio: '5046080c52a6ae366fb99a0f73d22b068c9ad3bf.mp3' },
          { zh: '这物品属于限制物品', en: 'This is a restricted article.', audio: '716df560206ebb7f8eba625cfae58771741df120.mp3' },
          { zh: '请稍等，我们需要联系您的航空公司', en: 'Please wait, we need to contact your airline.', audio: '54c3c02ae398c87b661e0a08659b7a9350c7a529.mp3' },
          { zh: '请问您会在 14 天内返回香港吗？', en: 'Will you be returning to Hong Kong within 14 days?', audio: '8c024a6a4f9db024e9bb775856e81f22e38286fe.mp3' },
          { zh: '我们将为您的物品发出一张财产收据，您可以在 14 天内前往航空公司办公室领回物品。', en: "We will issue a property receipt for your item(s), and you can collect the item(s) at the airline's office within 14 days.", audio: '5009cb36ef45dc0651d91cc212117864f33ac7e0.mp3' },
          { zh: '您可以选择将其弃置', en: 'You may choose to dispose it.', audio: 'f6e5e352378a5251d682a6198f34da112b590714.mp3' }
        ]
      },
      // ===== New Course: TAD E-Gates / Assisted Channel =====
      {
        id: 'course_8',
        title: 'TAD E-Gates / Assisted Channel (自助通關/人工通道)',
        color: '#bae6fd',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '请看摄像头。', en: 'Please look at the camera.', audio: '40415db54de921788dc885a12c40afb00229d0b2.mp3' },
          { zh: '请扫描您的护照/登机证', en: 'Please scan your passport / boarding pass.', audio: 'bec1bdf6172964472b82fc1b686db70716b89eda.mp3' },
          { zh: '请看摄像头。', en: 'Please look at the camera.', audio: '40415db54de921788dc885a12c40afb00229d0b2.mp3' },
          { zh: '请使用另一个闸口。', en: 'Please use another gate.', audio: '862e8462c8f9a4a745f3a72fb696dbb08ba09e51.mp3' },
          { zh: '请一个接一个地前往', en: 'Please proceed one by one.', audio: 'edca2d4f10abe719c19479ca398cdc712e920d66.mp3' },
          { zh: '请脱下您的口罩/眼镜/帽子', en: 'Please take off your mask / glasses/ hat.', audio: '3c58b84d49a5aaf56f73d74037321143ba62e659.mp3' },
          { zh: '请问他/她几岁？他/她是11岁以下吗？', en: 'How old is he / she? Is he/she under 11 years old?', audio: '5d3f9e9a358668904be11b703ee76f72951fa8c9.mp3' },
          { zh: '抱歉，先生/女士，这本不是电子护照/这本护照没有电子芯片。', en: 'Sorry Sir / Madam, this is not an e-passport / This passport has no chip.', audio: 'ff0effbb195680a87f7b4bbb249d8276bb46f12e.mp3' },
          { zh: '这个闸口机好像出现问题，请使用另一个闸口', en: 'There seems to be a problem with this machine, please try another one.', audio: 'adb406f7414afa9809cab87673c1968778d7a075.mp3' },
          { zh: '请前往那边人工柜台', en: 'Please go to the assisted channel.', audio: 'c20c945285c9c7fb0b169fad5975a466997b0350.mp3' },
          { zh: '请返回航空公司柜台寻求协助。', en: 'Please go back to your airline desk for help.', audio: '0271519b6c9dd11ea94565d7e5de71d540832ab3.mp3' },
          { zh: '抱歉，登机证上的姓名与护照上的姓名不符。', en: 'Sorry, the boarding pass name does not match with the passport.', audio: 'e93b71efabc50b4a3331c6ebeac72864b13a97c3.mp3' },
          { zh: '名字拼写错误', en: 'The name is misspelled.', audio: 'f3e10f912989c21888fe314c62e22fe74e6b9a62.mp3' },
          { zh: '名字无法完全显示', en: 'The name cannot be shown completely.', audio: '44c7fa9394b2bf5a1e8b291d36ace31c514a778a.mp3' },
          { zh: '这张登机证已过期', en: 'This boarding pass is expired.', audio: '72ab69f97c11cf3a315b60ed1b3d11dacc455df4.mp3' },
          { zh: '不好意思，系统显示你需要与航空公司联系', en: 'Sorry, the system shows that you need to contact the airline.', audio: '7033598ec173a5c49cf341d8d16e16d539a61105.mp3' }
        ]
      },
      // ===== New Course: TAD HBL =====
      {
        id: 'course_9',
        title: 'TAD HBL (随身行李)',
        color: '#fecdd3',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '您的随身行李可能过大。请你过来让我们量度您的行李', en: 'Your carry-on bag seems to be oversized. Please come over so we can measure the luggage.', audio: '93d604dcc2de706ed4f3f2cff2e537b5a6a47804.mp3' },
          { zh: '抱歉，此手提物品不符合尺寸要求。', en: "I'm sorry, this hand-carry item does not meet the size requirements. / Your carry-on bag is oversized.", audio: '98320f06e8d8ef522fbdafa8bef939dd6921fca6.mp3' },
          { zh: '抱歉，航空公司规定每位乘客只允许携带一件手提行李。/ 您的随身行李太多了。', en: "I'm sorry, the airline policy allows each passenger to carry only one piece of hand-carry luggage. / You have too many carry-on bags.", audio: 'f0aee37b2e8425f97af4809a666917cfe5074807.mp3' },
          { zh: '您可以选择重新整理您的随身行李。', en: 'You may choose to repack your hand-carry luggage.', audio: '72bfff5a15782eb0d5e584be29ef24ded4e09e43.mp3' }
        ]
      },
      // ===== New Course: Useful Vocabularies - RA/DB =====
      {
        id: 'course_10',
        title: 'Useful Vocabularies - RA/DB (常用词汇-违禁品/危险品)',
        color: '#fde68a',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '烟花', en: 'fireworks', audio: 'a85f18261c0688f38dd4067dd7f5757804e2750b.mp3' },
          { zh: '胡椒喷剂', en: 'pepper spray', audio: '1d08819045a27fa7042375404408ebbe7cbdf9f3.mp3' },
          { zh: '开放式剃刀', en: 'open razors', audio: 'e507847f498a3ca9935205849dc0c97cf18cc5bc.mp3' },
          { zh: '弹弓', en: 'slingshots', audio: '45112fa79ea28084d9a1dfe6fb595fe238546796.mp3' },
          { zh: '枪式打火机', en: 'gun lighters', audio: 'a4ad52af632d9f0f12a69cf2803a8f78f3d702f9.mp3' },
          { zh: '催泪气体', en: 'tear gas', audio: '3834d9fbfd34232becbe782c07260be05b70ba2c.mp3' },
          { zh: '多功能小刀', en: 'utility knives', audio: '9404ad9ab1375c9935745fb6be6edf2e5708a071.mp3' },
          { zh: '弹簧折刀', en: 'flick knives', audio: '9491dcd828113cf8ab88d178c6034042cde4e779.mp3' },
          { zh: '剑', en: 'swords', audio: 'd6056e47d33a009d754613afbb20a3a386496177.mp3' },
          { zh: '锤子', en: 'hammers', audio: '5528a5c097d00089755d62e64cefde986a20394b.mp3' },
          { zh: '钳子', en: 'pliers', audio: '9aeea494fb97cd0272a532727164a5b601fe5119.mp3' },
          { zh: '双节棍', en: 'nunchaku', audio: '513325a9f91f515c8fdf522b4ae849154b69c735.mp3' },
          { zh: '库巴桑', en: 'kubasaunts', audio: '8c0901027b95f61c10f9c9ae02d7ec3eb7dea4b5.mp3' },
          { zh: '螺丝批', en: 'screwdrivers', audio: '062b145d6e5d7d80d93e91bfa661941b02493d6b.mp3' }
        ]
      },
      // ===== New Course: Useful Vocabularies - LAGs =====
      {
        id: 'course_11',
        title: 'Useful Vocabularies - LAGs (常用词汇-液体/凝胶/气溶胶)',
        color: '#c4b5fd',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '香水', en: 'perfume', audio: '71ea58aa789b63d377fa73c441348da5840bd0dc.mp3' },
          { zh: '发胶', en: 'hair gel', audio: 'b1f12a940d3e0f0074bf61c1dab6ee2ce34d2437.mp3' },
          { zh: '洗发水', en: 'shampoos', audio: 'c0416229eb7acdcea4de95cf365e78c1241232be.mp3' },
          { zh: '防晒霜', en: 'sunscreen', audio: 'd205a5bffb98c164462cd8b4a3926938836e9b0c.mp3' },
          { zh: '香氛喷雾', en: 'body spray', audio: '57ad81b589a5f9d428b618f982ece4e3ff7e3781.mp3' },
          { zh: '咳嗽糖浆', en: 'cough syrup', audio: '637d5fc99710f5f25b8785204cca6fdcbfbf398e.mp3' },
          { zh: '牙膏', en: 'toothpaste', audio: '22ef5ba4d44a78205c392980e5c722f2f2f88727.mp3' },
          { zh: '液体洗面奶', en: 'liquid face cleanser', audio: '5db5addbcea10198a99d779ff0daae16e0d5230c.mp3' },
          { zh: '乳液', en: 'lotions', audio: '06f142ee2fb4ad4db0eb6b0b09eac1bf4c2df99a.mp3' },
          { zh: '面霜', en: 'creams', audio: '03287ac0afb395fd88a92182d8cc10f286f09e4e.mp3' },
          { zh: '湯', en: 'soups', audio: '0cee3930daa5845f23059b3008a8bc4e7b70e4b7.mp3' },
          { zh: '醬汁', en: 'sauces', audio: 'de2327ce9be81e6cad9e75326e1bc139b876ace8.mp3' }
        ]
      },
      // ===== New Course: Useful Vocabularies - Carry-on Items =====
      {
        id: 'course_12',
        title: 'Useful Vocabularies - Carry-on Items (常用词汇-随身物品)',
        color: '#bbf7d0',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '卷画', en: 'Scrolls', audio: 'c79dc6889c1f96c69ce4343f2fa853d3e7f4e4e3.mp3' },
          { zh: '球拍', en: 'Rackets', audio: '5897c368113afa34efb174587a85f2b4f8e2e5d9.mp3' },
          { zh: '网球拍', en: 'Tennis rackets', audio: '475ae388497bc998c3b6c5dc8994c9f81386a235.mp3' },
          { zh: '羽毛球拍', en: 'Badminton Rackets', audio: 'ee60e7ef566ae6ec88ebebb295e07be734cc4d16.mp3' },
          { zh: '乐器', en: 'Musical instruments', audio: '21318bb509c683933f55b08f1a7d8273df6af7a1.mp3' },
          { zh: '望远镜', en: 'Binoculars', audio: '8bfa5c57e6fa7d43f84c21bd13857803759d70e8.mp3' },
          { zh: '手提摄录机', en: 'Handheld camcorders', audio: 'aa764cbef9df0ec373b6cf8552f76e056edc3ab8.mp3' },
          { zh: '笔记型电脑', en: 'Laptops', audio: '8632c32a7b0a4b8b0c3856f9af2f93ff486719d2.mp3' },
          { zh: '外套', en: 'Coats', audio: '7283393894531e3e099a8df55337fd036ca4b515.mp3' },
          { zh: '伞', en: 'Umbrellas', audio: 'b04e40d6c4b172a53c1b297ef8e44dbbe21358ea.mp3' },
          { zh: '手杖', en: 'Walking sticks', audio: '2c3af0b431b7855735e278a6f8823c824988258b.mp3' }
        ]
      },
      // ===== New Course: Useful Vocabularies - Liquids & Packaging =====
      {
        id: 'course_13',
        title: 'Useful Vocabularies - Liquids & Packaging (常用词汇-液体及包装)',
        color: '#fbcfe8',
        cover: 'assets/img/cover-greeting.jpg', // placeholder
        phrases: [
          { zh: '液体', en: 'Liquid', audio: '4ad3e2141b2afe3691f32c2af3fc5cc3653cd453.mp3' },
          { zh: '凝胶', en: 'Gel', audio: '5bc773e4b76960897f5d4cb9ee9a5eab48ca70cd.mp3' },
          { zh: '喷雾', en: 'Aerosol', audio: '69ebcd89b95787c443493ab302b0679113ca790e.mp3' },
          { zh: '可重复密封透明塑胶袋', en: 'Transparent re-sealable plastic bag', audio: 'f814c4115bae34714a0a9030bbc8e06cb3872b48.mp3' },
          { zh: '容器', en: 'Container', audio: 'e6443af99d2f470f50affd5057bf48db2d09dae4.mp3' },
          { zh: '航空公司登记柜台', en: 'Airline check-in counter', audio: 'e3ce92bb6fd4b9c695466159b3008ce14eada6c1.mp3' },
          { zh: '弃置', en: 'Disposal', audio: '5fad6696d4de8beed28d84d5f68015a6a71582e2.mp3' },
          { zh: '倒', en: 'Pour', audio: 'c4a8cc808fe01786c3a64f409b4374a71b635d20.mp3' },
          { zh: '升', en: 'Litre', audio: '7d43efc4d9e3d215e34a9b4b13e398e72a23bb71.mp3' },
          { zh: '毫升', en: 'Millilitre', audio: 'f15b013b7c0f328a7e322f9cc3f84270f714dda6.mp3' },
          { zh: '药物', en: 'Medication', audio: '36da837e8b37f7433a84404f6a51700c59c816a8.mp3' }
        ]
      },
      // (legacy combined direction_guide_1 course removed)
    ];

    // ====== 狀態儲存 ======
    const Views = { home: qs('#home'), practice: qs('#practice'), reports: qs('#reports'), profile: qs('#profile') };
    const Tabs = $$('.tab');
    let session = null; // {course, idx, results:[], hard:Set, easy:Set}
    const store = {
      get nick(){ return localStorage.getItem('ms_nick')||'' },
      set nick(v){ localStorage.setItem('ms_nick', v||'') },
      get stats(){ return JSON.parse(localStorage.getItem('ms_stats')||'{"sessions":0,"scores":[]}') },
      set stats(v){ localStorage.setItem('ms_stats', JSON.stringify(v)) }
    }
const EVAL_URL = 'eval-sa.php';
// Global switch: show pronunciation tips (default OFF).
// To enable at runtime: set window.MS_SHOW_TIPS = true in the console or before this script.
window.MS_SHOW_TIPS = window.MS_SHOW_TIPS ?? false;


// Debug logging switch (turn off in production)
window.MS_DEBUG = (typeof window.MS_DEBUG === 'boolean') ? window.MS_DEBUG : false;

//for debug use only
async function logEvent(event, data, msg) {
  if (!window.MS_DEBUG) return;
  try {
    const fd = new FormData();
    fd.append('event', event);
    fd.append('page', location.pathname + location.hash);
    if (msg) fd.append('msg', String(msg));
    if (data != null) fd.append('data', JSON.stringify(data));
    await fetch('log.php', { method:'POST', body: fd, credentials:'include' });
  } catch (e) { /* ignore */ }
}



// 依 SOE 結果挑詞；若沒有可用詞就退回隨機挑
function deriveMistakesFromSoe(soeWords, fallbackWords) {
  try {
    const items = Array.isArray(soeWords) ? soeWords : [];
    // 清洗：只取有 Word 與 PronAccuracy 的項目
    const scored = items
      .map(w => ({
        w: String((w.Word ?? w.word ?? '')).replace(/[^A-Za-z']/g, ''),
        acc: Number(w.PronAccuracy ?? w.pronAccuracy ?? NaN)
      }))
      .filter(x => x.w && !Number.isNaN(x.acc));

    // 低準確度優先，其次字面順序
    const bad = scored
      .filter(x => x.acc < SOE_BAD_ACC)
      .sort((a,b) => a.acc - b.acc)
      .slice(0, SOE_MAX_TOKENS)
      .map(x => x.w);

    if (bad.length) return bad;

    // 若都不差，挑可能的功能詞以外的詞作輕提醒（取 1–2 個）
    const contentWords = (fallbackWords || [])
      .map(w => w.replace(/[^A-Za-z']/g,''))
      .filter(Boolean)
      .filter(w => !/^(the|a|an|and|or|to|of|in|on|at|for|with|by|from)$/i.test(w));

    if (contentWords.length) {
      return contentWords.slice(0, Math.min(2, SOE_MAX_TOKENS));
    }
  } catch (_) {}

  // 最後保底：沿用舊的隨機挑詞（若有）
  if (typeof pickMistakes === 'function') {
    return pickMistakes(fallbackWords || []);
  }
  return [];
}


    // ====== 初始化 ======
    // Measure header/tabbar and expose heights via CSS variables for safe-area aware layout
    function measureAndSetLayoutVars(){
      try {
        const root = document.documentElement;
        const app = document.querySelector('.appbar');
        const tab = document.querySelector('.tabbar');
        const ah = app ? Math.round(app.getBoundingClientRect().height) : 56;
        const th = tab ? Math.round(tab.getBoundingClientRect().height) : 64;
        root.style.setProperty('--appbar-h', ah + 'px');
        root.style.setProperty('--tabbar-h', th + 'px');
      } catch(_) {}
    }
    document.addEventListener('DOMContentLoaded', () => {
      try { requestAnimationFrame(measureAndSetLayoutVars); } catch(_) { measureAndSetLayoutVars(); }
      try { window.addEventListener('resize', measureAndSetLayoutVars); } catch(_) {}
      try { window.addEventListener('orientationchange', measureAndSetLayoutVars); } catch(_) {}
      try { window.visualViewport && window.visualViewport.addEventListener('resize', measureAndSetLayoutVars); } catch(_) {}
      // Custom tab wiring with special re-click logic for Practice tab
      Tabs.forEach(t => t.addEventListener('click', () => {
        const tabName = t.dataset.tab;
        // If user re-clicks the active Practice tab while a session is in progress, exit to course list
        if (tabName === 'practice' && t.classList.contains('active') && session && session.course) {
          exitPracticeToCourseList();
          return; // stay on practice tab
        }
        switchTab(tabName);
      }));
      // Wire explicit exit course button
      try {
        const btnExit = document.getElementById('btnExitCourse');
        if (btnExit) btnExit.addEventListener('click', () => exitPracticeToCourseList());
      } catch(_) {}
      const nick = qs('#nickname'); nick.value = store.nick; nick.addEventListener('change', e=>store.nick=e.target.value);
      renderCourses(); updateReports(); wirePracticeControls();
      // initialize tab icons
      Tabs.forEach(tab => {
        const img = tab.querySelector('img');
        if(!img) return;
        const sel = tab.classList.contains('active');
        img.src = sel ? tab.dataset.iconSelected : tab.dataset.iconDefault;
      });
          // show admin-only links if user is Admin*
          try {
            const isAdmin = String(window.SESSION_USER?.name || '').startsWith('Admin');
            const overallBtn = document.getElementById('btnOverallReports');
            if (overallBtn) overallBtn.classList.toggle('hidden', !isAdmin);
          } catch (_) {}
          // wire report buttons to embed the pages within the tab
          try {
            const linksRow = document.getElementById('reportLinksRow');
            const embedWrap = document.getElementById('reportEmbed');
            const frame = document.getElementById('reportFrame');
            const backBtn = document.getElementById('btnReportBack');
            const btnInd = document.getElementById('btnReportIndividual');
            const btnAll = document.getElementById('btnOverallReports');
            const adjustReportFrameHeight = () => {
              try {
                if (!frame || embedWrap?.classList?.contains('hidden')) return;
                const rectTop = frame.getBoundingClientRect().top;
                const vh = window.innerHeight || document.documentElement.clientHeight || 600;
                const tabbarH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tabbar-h')||'64', 10) || 64;
                const target = Math.max(200, vh - rectTop - tabbarH - 12);
                frame.style.height = target + 'px';
              } catch(_) {}
            };
            const showFrame = (url) => {
              if (!frame) return;
              frame.src = url;
              if (embedWrap) embedWrap.classList.remove('hidden');
              if (linksRow) linksRow.classList.add('hidden');
              backBtn?.classList?.remove('hidden');
              // adjust height after layout and once content loads
              try { requestAnimationFrame(adjustReportFrameHeight); } catch(_) {}
              try { frame.addEventListener('load', adjustReportFrameHeight, { once:true }); } catch(_) {}
            };
            const hideFrame = () => {
              if (embedWrap) embedWrap.classList.add('hidden');
              if (linksRow) linksRow.classList.remove('hidden');
              if (frame) frame.src = 'about:blank';
              backBtn?.classList?.add('hidden');
            };
            backBtn?.addEventListener('click', hideFrame);
            btnInd?.addEventListener('click', () => showFrame('reports/report_individual.php'));
            btnAll?.addEventListener('click', () => showFrame('reports/report_overall.php'));
            window.addEventListener('resize', adjustReportFrameHeight);
          } catch (_) {}
          // populate pins (show up to 8 pins named pin1.png..pin8.png)
          try {
            const pinsWrap = qs('#myPins');
            if (pinsWrap) {
              pinsWrap.innerHTML = '';
              for (let i=1;i<=8;i++) {
                const d = document.createElement('div'); d.className='pin';
                const img = document.createElement('img'); img.src = `assets/pins/pin${i}.png`; img.alt = `pin${i}`;
                d.appendChild(img); pinsWrap.appendChild(d);
              }
            }
          } catch(e) { console.warn('populate pins failed', e); }
    });

    function switchTab(tab){ Object.values(Views).forEach(v => v.classList.remove('active')); qs('#'+tab).classList.add('active');
      Tabs.forEach(t => {
        const isActive = t.dataset.tab===tab;
        t.classList.toggle('active', isActive);
        const img = t.querySelector('img'); if(img) img.src = isActive ? t.dataset.iconSelected : t.dataset.iconDefault;
      });
    }

    // ====== 課程清單 ======
    function renderCourses(){
      const wrap = qs('#courseList'); wrap.innerHTML = '';
      COURSES.forEach(c => {
        const el = document.createElement('div'); el.className='card course';
        el.innerHTML = `
          <div class="avatar" style="background:${c.color||'#e2e8f0'}">${c.title[0]}</div>
          <div class="meta"><div class="title">${c.title}</div><div class="sub">${c.phrases.length} 句 · 英/中</div></div>
          <div class="right muted">開始 →</div>`;
        el.addEventListener('click', () => startSession(c)); wrap.appendChild(el);
      });
    }

    // ====== 練習流程 ======
    const sessionBox = qs('#session');
  const counter = qs('#counter'); const progressBar = qs('#progressBar');
  const fcZh = qs('#fcZh'); const fcEn = qs('#fcEn'); const chips = qs('#chips');
  const card = qs('#flashcard'); let touchX = null;
  const btnPlay = qs('#btnPlay'); const btnRecord = qs('#btnRecord');
    const btnPlayback = qs('#btnPlayback'); const btnScore = qs('#btnScore'); const btnPrev = qs('#btnPrev'); const btnNext = qs('#btnNext');
  const resultBox = qs('#result');
  let mediaRecorder, recordedChunks = [], recordedBlob = null, recordedMimeType = '';
  let recordedUrl = '';
  let currentStandardUrl = '';
  // Recording timers/state for countdown
  let recordAutoStopTimer = null;
  let recordCountdownTimer = null;
  const RECORD_MAX_MS = 14900;
  let recordStartedAt = 0;
// Use a single audio element for playback
const audioEl = document.createElement('audio');
audioEl.id = 'recPreview';
audioEl.controls = false;
audioEl.preload = 'metadata';
audioEl.playsInline = true; audioEl.setAttribute('playsinline', ''); audioEl.muted = false;
audioEl.style.display = 'none';
document.body.appendChild(audioEl);
  // Fallback recorder state (for iOS Safari / browsers without MediaRecorder or unsupported mime types)
  let fallbackRecorder = null;

  function setPlaybackBlob(blob, mime) {
    // Revoke old URL if present
    try { if (recordedUrl) URL.revokeObjectURL(recordedUrl); } catch(_) {}
    recordedBlob = blob;
    recordedMimeType = (mime || blob?.type || '').toLowerCase();
    recordedUrl = recordedBlob ? URL.createObjectURL(recordedBlob) : '';
    audioEl.src = recordedUrl || '';
    try { audioEl.load(); } catch(_) {}
    const has = !!(recordedBlob && recordedBlob.size);
    btnPlayback.disabled = !has;
    btnScore.disabled = !has;
    // reset toggle UI
    updatePlaybackUi(false);
  // iOS: ensure buttons reflect latest availability
  try { refreshRecordedAvailability(); setTimeout(refreshRecordedAvailability, 0); } catch(_) {}
  }
    // Helper: encode Float32 samples to WAV ArrayBuffer

 async function sniffAudioExt(blob) {
  try {
    const head = new Uint8Array(await blob.slice(0, 16).arrayBuffer());
    // WAV: "RIFF....WAVE"
    if (head[0]===0x52 && head[1]===0x49 && head[2]===0x46 && head[3]===0x46) return 'wav';
    // MP3: "ID3" or MPEG sync
    if (head[0]===0x49 && head[1]===0x44 && head[2]===0x33) return 'mp3';
    if (head[0]===0xFF && (head[1] & 0xE0) === 0xE0) return 'mp3';
    // M4A/MP4: "ftyp" in bytes 4-7, major brands: M4A, isom, mp42, etc.
    if (head[4]===0x66 && head[5]===0x74 && head[6]===0x79 && head[7]===0x70) {
      // Check for m4a/mp4 major brands
      const brand = String.fromCharCode(head[8],head[9],head[10],head[11]).toLowerCase();
      if (brand==='m4a '||brand==='mp4 '||brand==='isom'||brand==='mp42') return 'm4a';
      return 'mp4';
    }
    // OGG: "OggS"
    if (head[0]===0x4F && head[1]===0x67 && head[2]===0x67 && head[3]===0x53) return 'ogg';
    // WEBM: "\x1A\x45\xDF\xA3"
    if (head[0]===0x1A && head[1]===0x45 && head[2]===0xDF && head[3]===0xA3) return 'webm';
    // FLAC: "fLaC"
    if (head[0]===0x66 && head[1]===0x4C && head[2]===0x61 && head[3]===0x43) return 'flac';
    // AIFF: "FORM"
    if (head[0]===0x46 && head[1]===0x4F && head[2]===0x52 && head[3]===0x4D) return 'aiff';
    // If blob has a type property, check mime type
    if (blob.type) {
      if (/wav/i.test(blob.type)) return 'wav';
      if (/mp3/i.test(blob.type)) return 'mp3';
      if (/m4a/i.test(blob.type)) return 'm4a';
      if (/mp4/i.test(blob.type)) return 'mp4';
      if (/ogg/i.test(blob.type)) return 'ogg';
      if (/webm/i.test(blob.type)) return 'webm';
      if (/flac/i.test(blob.type)) return 'flac';
      if (/aiff/i.test(blob.type)) return 'aiff';
    }
  } catch(e){}
  return null;
}

async function debugBeacon(tag, obj) {
  if (!window.MS_DEBUG) return;
  try {
    const fd = new FormData();
    fd.append('event', tag);
    fd.append('data', JSON.stringify(obj||{}));
    await fetch('log.php', { method:'POST', body: fd, credentials:'include' });
  } catch(e){}
}

// Build eval context for logging
function getEvalCtx() {
  try {
    const cid = session?.course?.id || '';
  const idx = Number(session?.idx ?? -1);
  const uid = cid ? `${cid}#${(idx+1)}` : '';
    // Keep minimal identifiers: only phrase_uid
    return { phrase_uid: uid };
  } catch (_) { return { phrase_uid:'' }; }
}

// Redact potentially sensitive text fields from SA responses
function redactEvalObject(obj){
  try {
    const clone = JSON.parse(JSON.stringify(obj||{}));
    const stripKeys = new Set(['text','reference_text','ref_text','refText','referenceText']);
    const walk = (v) => {
      if (Array.isArray(v)) { v.forEach(walk); }
      else if (v && typeof v === 'object') {
        Object.keys(v).forEach(k => {
          if (stripKeys.has(k)) delete v[k]; else walk(v[k]);
        });
      }
    };
    walk(clone);
    return clone;
  } catch(_) { return {}; }
}


    // Centralized availability refresh for recorded clip
    function refreshRecordedAvailability(){
      try {
        const has = !!(recordedBlob && recordedBlob.size);
        btnPlayback.disabled = !has;
        btnScore.disabled = !has;
      } catch(_) {}
    }

  //start recording and forecewave

// Simplified: always use MediaRecorder with platform default format
async function startRecording() {
  if (!navigator.mediaDevices || !window.MediaRecorder) {
  alert('此浏览器不支持录音。');
    return;
  }
  try {
    // Prefer mono for scoring APIs; browsers may ignore channelCount (safe hint)
  const stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 16000 } });
    // Pick a SpeechAce-friendly format when possible (Opus WebM; Safari will fall back)
    const preferred = ['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/mpeg'];
    const pick = (MediaRecorder.isTypeSupported)
      ? preferred.find(t => MediaRecorder.isTypeSupported(t))
      : null;
    const bitrateByType = {
      'audio/webm;codecs=opus': 64000,
      'audio/webm': 64000,
      'audio/mp4': 64000,
      'audio/mpeg': 96000,
    };
    const opts = pick ? { mimeType: pick, audioBitsPerSecond: bitrateByType[pick] || 64000 } : undefined;
    mediaRecorder = opts ? new MediaRecorder(stream, opts) : new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = () => {
      // Safari may dispatch dataavailable after stop; wait a tick to assemble blob
      setTimeout(() => {
        try {
          const blob = new Blob(chunks, { type: mediaRecorder.mimeType || '' });
          setPlaybackBlob(blob, mediaRecorder.mimeType || '');
        } catch(_) {}
        btnRecord.disabled = false;
        btnRecord.textContent = '● 录音';
        // Clear timers when recording ends
        clearRecordTimers();
        // Re-enable controls after recording finishes
        updateRecordingUi(false);
        // Robust re-evaluation on iOS timing quirks
        try { refreshRecordedAvailability(); } catch(_) {}
        setTimeout(refreshRecordedAvailability, 0);
        try { requestAnimationFrame(() => refreshRecordedAvailability()); } catch(_) {}
        setTimeout(refreshRecordedAvailability, 50);
      }, 0);
      // Stop mic tracks
      try { (mediaRecorder.stream?.getTracks?.() || []).forEach(t => t.stop()); } catch(_) {}
    };
    // Reset playback state on new recording
    recordedBlob = null;
    recordedMimeType = '';
  // Stop any ongoing playback and reset UI
  try { audioEl.pause(); audioEl.currentTime = 0; } catch(_) {}
    audioEl.src = '';
  updatePlaybackUi(false);
  updateStandardPlayUi(false);
  // While recording starts, temporarily disable playback and score
  btnPlayback.disabled = true;
  btnScore.disabled = true;
    mediaRecorder.start();
  // Ensure source cleared is applied in iOS before we create new blob later
  setTimeout(() => { try { if (audioEl.src) audioEl.src = ''; } catch(_) {} }, 0);
    // Start countdown
    recordStartedAt = Date.now();
    updateRecordCountdownLabel();
  recordCountdownTimer = setInterval(updateRecordCountdownLabel, 500);
  // While recording, disable play/playback/score but keep record button enabled for toggle
  updateRecordingUi(true);
    // auto-stop after 15s
    recordAutoStopTimer = setTimeout(()=>{ try{ mediaRecorder?.state!=='inactive' && mediaRecorder.stop(); }catch(_){} }, RECORD_MAX_MS);
  } catch (err) {
  alert('麦克风权限被拒或不可用。');
    console.error(err);
    // Reset label on failure
  try { clearRecordTimers(); btnRecord.textContent = '● 录音'; btnRecord.disabled = false; updateRecordingUi(false); } catch(_) {}
  }
}


    function startSession(course){
      qs('#courseTitle').textContent = course.title; qs('#summary').classList.remove('visible');
      session = { course, idx:0, results:[], hard:new Set(), easy:new Set() };
      // hide the static "課程列表" heading when the user starts a session
      const practiceHeader = qs('#practice h2'); if(practiceHeader) practiceHeader.classList.add('hidden');
      qs('#courseList').classList.add('hidden'); sessionBox.classList.remove('hidden');
      // show exit button once
      try { qs('#btnExitCourse')?.classList.remove('hidden'); } catch(_) {}
      // load first card
      loadCard();
    }
    // Exit current practice session back to the course list (invoked on re-click of Practice tab)
    function exitPracticeToCourseList(){
        try { if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); } catch(_) {}
        clearRecordTimers?.();
        // Reset UI state
        session = null;
        sessionBox.classList.add('hidden');
        // Reveal heading and course list
        const practiceHeader = qs('#practice h2'); if(practiceHeader) practiceHeader.classList.remove('hidden');
        const cl = qs('#courseList'); if (cl) cl.classList.remove('hidden');
        // Clear flashcard content to avoid stale phrase display
        try { fcZh.textContent = '—'; fcEn.textContent = '—'; chips.innerHTML=''; counter.textContent='0/0'; progressBar.style.width='0%'; } catch(_) {}
        // Clear result panel
        try { clearResult(); } catch(_) {}
        // Reset standard audio & recorded clip state
        try {
          if (audioEl) { audioEl.pause(); audioEl.currentTime = 0; audioEl.src=''; }
          setPlaybackBlob(null, '');
        } catch(_) {}
        // Reset buttons
        try { btnRecord.disabled = false; btnRecord.textContent = '● 录音'; updateRecordingUi(false); updatePlaybackUi(false); updateStandardPlayUi(false); } catch(_) {}
        // Hide summary if visible
        try { qs('#summary')?.classList.remove('visible'); } catch(_) {}
        // Hide exit button
        try { qs('#btnExitCourse')?.classList.add('hidden'); } catch(_) {}
      /* swallow */
    }

    function loadCard(){
  const total = session.course.phrases.length; if(session.idx>=total){ return endSession(); }
  // ensure any swipe animation classes are cleared
  card.classList.remove('animating','swipe-left','swipe-right');
      const p = session.course.phrases[session.idx]; fcZh.textContent = p.zh; fcEn.textContent = p.en;
  // Remove pills display: just clear container
  chips.innerHTML = '';
      counter.textContent = `${session.idx+1}/${total}`; progressBar.style.width = `${((session.idx)/total)*100}%`;
  clearResult(); disable([btnPlayback, btnScore]);
  // manage prev button availability
  try { if (btnPrev) btnPrev.disabled = (session.idx <= 0); } catch(_) {}
    }

    function endSession(){
      progressBar.style.width = '100%';
      const scores = session.results.map(r=>r.score); const avg = scores.length? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : null;
      qs('#smCards').textContent = session.course.phrases.length; qs('#smAvg').textContent = avg!=null? `${avg}` : '—';
      qs('#smHard').textContent = session.hard.size; qs('#smEasy').textContent = session.easy.size; qs('#summary').classList.add('visible');
      const stats = store.stats; stats.sessions += 1; if(avg!=null) stats.scores.push(avg); store.stats = stats; updateReports();
    }

    function updateReports(){ const s = store.stats; qs('#rSessions').textContent = s.sessions; const avg = s.scores.length? Math.round(s.scores.reduce((a,b)=>a+b,0)/s.scores.length) : '—'; qs('#rAvg').textContent = avg; }

    // ====== 音訊控制 ======
    btnPlay.addEventListener('click', ()=>{
      if (!session || !session.course) return;
      const p = session.course.phrases[session.idx];
      currentStandardUrl = new URL(resolveAudio(p.audio), location.href).href;
      const isStdPlaying = (audioEl.src === currentStandardUrl) && !audioEl.paused;
      if (isStdPlaying) {
        try { audioEl.pause(); audioEl.currentTime = 0; } catch(_) {}
        updateStandardPlayUi(false);
      } else {
        // stop recorded playback toggle UI and switch to standard audio
        updatePlaybackUi(false);
        audioEl.src = currentStandardUrl;
        audioEl.currentTime = 0;
        audioEl.play().then(()=>{ updateStandardPlayUi(true); }).catch(()=>{ updateStandardPlayUi(false); });
      }
    });
  // Merge record/stop into one toggle button
  btnRecord.addEventListener('click', ()=>{
    try {
      if (mediaRecorder && mediaRecorder.state && mediaRecorder.state !== 'inactive') {
        try { mediaRecorder.stop(); } catch(_) {}
  // Fallback: ensure UI re-evaluates soon after stopping
  setTimeout(refreshRecordedAvailability, 100);
        return;
      }
    } catch(_) {}
    startRecording();
  });
  // Stop button removed; use Record to toggle stop

    btnPlayback.addEventListener('click', ()=>{
      if(!recordedBlob || !recordedBlob.size){ return; }
  // Defensive refresh before playing recorded audio
  try { refreshRecordedAvailability(); } catch(_) {}
      const isRecordedSource = !!recordedUrl && audioEl.src === recordedUrl;
      // If already playing recorded audio, toggle to stop
      if (isRecordedSource && !audioEl.paused) {
        try { audioEl.pause(); audioEl.currentTime = 0; } catch(_) {}
        updatePlaybackUi(false);
        return;
      }
      // Switch to recorded source and play
  if (!isRecordedSource) {
        audioEl.src = recordedUrl;
      }
      audioEl.currentTime = 0;
  audioEl.play()
        .then(()=>{ updatePlaybackUi(true); })
        .catch(err => { console.warn('Playback failed:', err); updatePlaybackUi(false); });
    });

    // Keep UI in sync with audio state (only when playing the recorded clip)
    audioEl.addEventListener('ended', ()=>{
      if (recordedUrl && audioEl.src === recordedUrl) {
        updatePlaybackUi(false);
        // ensure buttons reflect availability of the latest recorded clip
        try {
          const has = !!(recordedBlob && recordedBlob.size);
          btnPlayback.disabled = !has;
          btnScore.disabled = !has;
        } catch(_) {}
      }
      if (currentStandardUrl && audioEl.src === currentStandardUrl) updateStandardPlayUi(false);
    });
    audioEl.addEventListener('pause', ()=>{
      if (recordedUrl && audioEl.src === recordedUrl && audioEl.currentTime < (audioEl.duration||0)) {
        updatePlaybackUi(false);
        // Also refresh availability in case of iOS timing
        refreshRecordedAvailability();
      }
      if (currentStandardUrl && audioEl.src === currentStandardUrl && audioEl.currentTime < (audioEl.duration||0)) updateStandardPlayUi(false);
    });
    audioEl.addEventListener('loadedmetadata', ()=>{
      // When recorded clip becomes ready, refresh buttons
      if (recordedUrl && audioEl.src === recordedUrl) {
        refreshRecordedAvailability?.();
        setTimeout(() => refreshRecordedAvailability?.(), 0);
      }
    });

    // btnScore: call evaluateReal when resources ready, otherwise fallback to 
    
   btnScore?.addEventListener('click', onScoreClick, false);

async function onScoreClick(){
  try {
    showScoring?.(); disable?.([btnScore]);

    // sentence & words
    const p = session?.course?.phrases?.[session.idx];
    const text = (p?.en || '').replace(/\s+/g,' ').trim();
    const words = (p?.en || '').replace(/[^A-Za-z'\s]/g,'').split(/\s+/).filter(Boolean);
    if (!text) throw new Error('no-text');

    // blob sanity
    const blob = recordedBlob;
    const mime = (recordedMimeType || blob?.type || '').toLowerCase();
    if (!blob || !blob.size) {
  toast('请先录音再评分');
      enable?.([btnScore]);
      return;
    }

    // pick an extension SpeechAce is happy with
    let ext = await sniffAudioExt(blob);
    if (!ext && mediaRecorder?.mimeType?.includes('/')) {
      ext = mediaRecorder.mimeType.split('/')[1];
    }
    if (!ext) ext = 'webm';

  await debugBeacon('eval_pre', {
  hasBlob: !!(blob && blob.size), mime, size: blob?.size||0, textLen: text.length, ext,
  ...getEvalCtx()
    });

    // build request
    const fd = new FormData();
    fd.append('text', text);
    fd.append('dialect', 'en-us');
    fd.append('audio', blob, 'clip.'+ext);
    fd.append('user_id', window.SESSION_USER.name);
    fd.append('include_fluency', '1');
    fd.append('include_intonation', '1');
  // Ask server to include a Simplified Chinese summary paragraph
  fd.append('include_summary', '1');
    // Include phrase_uid so server can associate the eval
    try {
      const ctx = getEvalCtx();
      if (ctx && ctx.phrase_uid) fd.append('phrase_uid', ctx.phrase_uid);
    } catch(_) {}


    // call SpeechAce adapter
    const res = await fetch(EVAL_URL, { method:'POST', body: fd, credentials:'include' });
  await debugBeacon('eval_status', { status: res.status, ...getEvalCtx() });

  if (res.status === 401 || res.status === 403) { location.href = 'morningsir.php'; return; }

    let data = {};
    try { data = await res.json(); }
    catch {
      // avoid logging key named "text"; include context
  await debugBeacon('eval_parse_err', { body: await res.text().catch(()=>null), ...getEvalCtx() });
      throw new Error('json');
    }

    // log sanitized API response
    const redacted = redactEvalObject(data);
  await debugBeacon('eval_api_response', { response: redacted, ...getEvalCtx() });

    // NEW contract
    if (!res.ok || data?.status !== 'ok') throw new Error('bad');

    // Score & mistakes from SpeechAce adapter
    const score = Math.round(Number(data.overall ?? 0)) || 0;
    const weakWords = Array.isArray(data.weak_words)
      ? data.weak_words
          .map(w => ({ word: String(w.word||'').trim(), tip: String(w.tip||'').trim(), score: Number(w.score||0) }))
          .filter(x => x.word)
      : [];
    const mistakes = weakWords.map(w => w.word);
  await debugBeacon('eval_mistakes', { mistakes, ...getEvalCtx() });

  // compute metrics early and render per sequence
  const flu = Number(data.fluency ?? NaN);
  const fluencyRounded = Number.isNaN(flu) ? null : Math.round(flu);
  const pronunciation = Number.isFinite(Number(data.pronunciation)) ? Math.round(Number(data.pronunciation)) : null;

  showResult?.(score, mistakes, weakWords, fluencyRounded, pronunciation);

  // Show detailed explanation inline when present; skip otherwise
  try {
    const htmlSummary = typeof data.summary_zh === 'string' ? data.summary_zh.trim() : '';
    if (htmlSummary) {
      const wrap = document.createElement('div');
      wrap.className = 'summary-zh-wrap';
      wrap.style.marginTop = '10px';
      const panel = document.createElement('div');
      panel.className = 'card summary-zh-panel';
      panel.style.marginTop = '8px';
      const content = document.createElement('div');
      content.style.marginTop = '6px';
      content.innerHTML = htmlSummary; // trusted server HTML
      panel.appendChild(content);
      wrap.appendChild(panel);
      resultBox.appendChild(wrap);
    }
  } catch(_) {}

  // fluency now rendered inside showResult

    (session.results ||= {})[session.idx] = {
      score,
      mistakes,
      sa: { overall: data.overall, fluency: data.fluency, meta: data.meta }
    };

    // one-line eval summary for analytics
  await debugBeacon('eval_done', {
      score,
      fluency: Number(data.fluency ?? null),
      overall: Number(data.overall ?? null),
      mistakes,
      response: redacted,
      ...getEvalCtx()
    });
    enable?.([btnNext, btnScore]);
  } catch (e) {
  await debugBeacon('eval_catch', { err: String(e), ...getEvalCtx() });
  toast('评分失败，请重试');
    enable?.([btnScore]);
  }
}


  // navigate previous/next
  btnPrev?.addEventListener('click', ()=>{ if (!session) return; if (session.idx > 0) { session.idx -= 1; loadCard(); } });
  btnNext.addEventListener('click', ()=>{ session.idx += 1; loadCard(); });

  // 手勢
    card.addEventListener('touchstart', e=>{ touchX = e.changedTouches[0].clientX; },{passive:true});
    card.addEventListener('touchend', e=>{
      if(touchX==null) return;
      const dx = e.changedTouches[0].clientX - touchX; touchX=null;
      if(Math.abs(dx) < 40) return; // ignore small moves
      const isRight = dx>0;
      // trigger animation class
      card.classList.add('animating', isRight ? 'swipe-right' : 'swipe-left');
      // mark according to swipe
      if(isRight) markHard(); else markEasy();
      // advance after animation ends
      const onEnd = ()=>{
        card.removeEventListener('transitionend', onEnd);
        card.classList.remove('animating','swipe-right','swipe-left');
        if(session){ session.idx += 1; loadCard(); }
      };
      card.addEventListener('transitionend', onEnd);
    });
  function markHard(){ session.hard.add(session.idx); toast('已加入多练'); }
  function markEasy(){ session.easy.add(session.idx); toast('已标记为已认识'); }

    function clearResult(){ resultBox.classList.remove('visible'); resultBox.innerHTML=''; }
  function showScoring(){ resultBox.classList.add('visible'); resultBox.innerHTML = `<div class=\"row\"><div>AI 评分中…</div><div class=\"right muted\">~1s</div></div>`; }

  // Robust TTS helper (iOS-friendly)
  function speakWord(word, lang='en-US'){
    try {
      if (!('speechSynthesis' in window) || !word) return;
      const u = new window.SpeechSynthesisUtterance(String(word));
      u.lang = lang; u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;

      const startSpeak = () => {
        const voices = window.speechSynthesis.getVoices?.() || [];
        const v = voices.find(v => (v.lang||'').toLowerCase().startsWith(lang.toLowerCase()));
        if (v) u.voice = v;
        try { window.speechSynthesis.cancel(); } catch(_) {}
        // iOS quirk: nudge the engine
        try { window.speechSynthesis.pause(); window.speechSynthesis.resume(); } catch(_) {}
        window.speechSynthesis.speak(u);
      };

      if (!window.speechSynthesis.getVoices?.().length) {
        window.speechSynthesis.addEventListener('voiceschanged', startSpeak, { once:true });
        setTimeout(startSpeak, 400);
      } else {
        startSpeak();
      }
    } catch(e) {
      try { debugBeacon?.('tts_error', { err:String(e) }); } catch(_){}
    }
  }

  // Prime TTS once on first user interaction (helps iOS load voices)
  (function primeTTSOnce(){
    const prime = () => {
      try {
        window.speechSynthesis?.getVoices?.();
        const u = new window.SpeechSynthesisUtterance(' ');
        u.volume = 0; u.rate = 1; u.lang = 'en-US';
        try { window.speechSynthesis.cancel(); } catch(_) {}
        setTimeout(() => { try { window.speechSynthesis.speak(u); window.speechSynthesis.cancel(); } catch(_) {} }, 0);
      } catch(_) {}
    };
    document.addEventListener('click', prime, { once:true, passive:true });
    document.addEventListener('touchend', prime, { once:true, passive:true });
  })();
    // Feedback message by score: from encouragement to compliment
    function feedbackForScore(s){
      try {
        const n = Number(s) || 0;
        if (n >= 90) return '太棒了！几乎完美！';
        if (n >= 80) return '做得好！继续保持！';
        if (n >= 70) return '不错！再注意一些细节。';
        if (n >= 60) return '加油！多练几次会更好。';
        return '别气馁，坚持练习会进步。';
      } catch(_) { return '继续努力，加油！'; }
    }

  function showResult(score, mistakes, weakWords, fluency, pronunciation) {
      resultBox.classList.add('visible');
  const badge = `<span class=\"badge badge-real\">A.I. 分析结果</span>`;
      const pillsHtml = (mistakes && mistakes.length)
        ? `<div class=\"mistake-wrap\">重点练习：${mistakes.map(m=>`<span class='mistake' tabindex='0' role='button' aria-label='点击朗读'>${m}</span>`).join('')}</div>`
        : '';
      const tipsHtml = (window.MS_SHOW_TIPS && Array.isArray(weakWords) && weakWords.length)
        ? `<div class='muted' style='margin-top:4px'>提示：${weakWords.map(w=>{
              const t = (w.tip||'').replace(/[<>]/g,'');
              const ww = (w.word||'').replace(/[<>]/g,'');
              return `${ww}：${t}`;
            }).join('； ')}</div>`
        : '';
  // Metrics line: show 发音 first, then 流畅度 (总分 shown above)
  const metrics = [];
  if (pronunciation != null) metrics.push(`发音：${pronunciation}`);
  if (fluency != null) metrics.push(`流畅度：${fluency}`);
  // Remove duplicated 总分 from the metrics line (already shown as the main score)
      const metricsHtml = metrics.length
        ? `<div class=\"muted\" style=\"margin-top:6px\">${metrics.join(' · ')}</div>`
        : '';

  resultBox.innerHTML = `<div class=\"row\"><div class=\"score\">总分：${score}</div><div class=\"result-badge\">${badge}</div></div>`
        + metricsHtml
        + `<div class='muted' style='margin-top:8px'>${feedbackForScore(score)}</div>`
        + pillsHtml
        + tipsHtml;

      // Wire TTS for each weak-word pill using robust helper
      if (mistakes.length) {
        const pills = resultBox.querySelectorAll('.mistake');
        pills.forEach(pill => {
          const clone = pill.cloneNode(true);
          pill.replaceWith(clone);
          clone.addEventListener('click', () => {
            const word = (clone.textContent || '').trim();
            try { debugBeacon?.('tts_click', { word }); } catch(_){}
            speakWord(word, 'en-US');
          }, false);
        });
      }
    }

  // （預留）真實 API — implemented above as evaluateReal(blob, ext)

    // ====== 工具 ======
    function qs(sel, root=document){ return root.querySelector(sel); }
    function $$(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
    function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }
    function disable(btns){ btns.forEach(b=>b.disabled=true); }
    function enable(btns){ btns.forEach(b=>b.disabled=false); }
    function toast(msg){ const t = document.createElement('div'); t.textContent = msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='80px'; t.style.transform='translateX(-50%)'; t.style.background='#111827'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='999px'; t.style.boxShadow='var(--shadow)'; t.style.zIndex=99; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 900); }
    function pickMistakes(words){ if(words.length<=2) return []; const copy=[...words]; const n = Math.random()<0.5?1:2; const out=[]; for(let i=0;i<n;i++){ const idx = Math.floor(Math.random()*copy.length); out.push(copy.splice(idx,1)[0]); } return out; }
    // Toggle UI for playback button and disable conflicting controls while playing
  function updatePlaybackUi(isPlaying){
      try {
    btnPlayback.textContent = isPlaying ? '停止' : '回放';
        btnRecord.disabled = !!isPlaying;
        btnPlay.disabled = !!isPlaying;
      } catch(_) {}
    }
    // Toggle UI for standard play button and disable record/playback/score while playing standard audio
    function updateStandardPlayUi(isPlaying){
      try {
        btnPlay.textContent = isPlaying ? '停止' : '▶︎ 播放';
        btnRecord.disabled = !!isPlaying;
        btnPlayback.disabled = !!isPlaying || !(recordedBlob && recordedBlob.size);
        btnScore.disabled = !!isPlaying || !(recordedBlob && recordedBlob.size);
      } catch(_) {}
    }
    // While recording, disable play/playback/score, keep record enabled (to toggle stop)
    function updateRecordingUi(isRecording){
      try {
        btnPlay.disabled = !!isRecording;
        btnPlayback.disabled = !!isRecording || !(recordedBlob && recordedBlob.size);
        btnScore.disabled = !!isRecording || !(recordedBlob && recordedBlob.size);
      } catch(_) {}
    }
    // Update the record button label with remaining seconds
    function updateRecordCountdownLabel(){
      try {
        const elapsed = Math.max(0, Date.now() - recordStartedAt);
        const remainMs = Math.max(0, RECORD_MAX_MS - elapsed);
        const remainSec = Math.ceil(remainMs / 1000);
        btnRecord.textContent = `录音中… ${remainSec}s`;
        // Safety guard: if timers/drift cause delay, force-stop when elapsed >= limit
        if (elapsed >= RECORD_MAX_MS) {
          try { if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); } catch(_) {}
          clearRecordTimers();
        }
      } catch(_) {}
    }
    // Clear timers safely
    function clearRecordTimers(){
      try { if (recordCountdownTimer) { clearInterval(recordCountdownTimer); recordCountdownTimer = null; } } catch(_) {}
      try { if (recordAutoStopTimer) { clearTimeout(recordAutoStopTimer); recordAutoStopTimer = null; } } catch(_) {}
    }

    // 兼容舊版：某些版本會呼叫 wirePracticeControls()
    // 本檔已在內部綁好事件，這裡提供空函式避免報錯
    function wirePracticeControls(){}

// Values from the PHP session (safe to embed via json_encode)
// SESSION_USER value injection happens in morningsir.php
// Fallback: ensure SESSION_USER is always defined
window.SESSION_USER = window.SESSION_USER || { code: '', name: '访客' };
// 1) Update the existing store on every login/app load
try {
  localStorage.setItem('ms_nick', window.SESSION_USER.name);
  localStorage.setItem('ms_staffNo', window.SESSION_USER.code); // optional, if you use it elsewhere
} catch (e) {}

// 2) Keep the profile page unchanged, just show the session name and prevent edits
document.addEventListener('DOMContentLoaded', () => {
  const nick = document.getElementById('nickname');
  if (nick) {
    // Always show a valid nickname, fallback to '访客' if missing
  nick.value = typeof window.SESSION_USER.name === 'string' && window.SESSION_USER.name.trim() ? window.SESSION_USER.name : '访客';
    nick.readOnly = true;   // stop edits
    nick.disabled = true;   // greys it out & blocks events
    nick.title = '由系统设置（邀请码名册）';
  }
});
</script>

</body>
</html>